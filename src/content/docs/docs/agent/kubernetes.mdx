---
title: Instrumenting Kubernetes Workloads
description: Documentation on instrumenting Kubernetes workloads with the Archodex Agent
---

import { Aside } from '@astrojs/starlight/components';

---

Many workloads interact with shared resources. Observing all the resources workloads interact with requires runtime
instrumentation. If you are running workloads on Kubernetes, Archodex makes it easy to instrument individual workloads
or an entire cluster.

## Cluster or Workload Instrumentation

Instrumenting all workloads on a cluster provides the most operational intelligence. However, you can instrument with
Archodex at the workload level instead if:

- You want to try Archodex on a limited set of workloads before deploying more widely
- You have access to modify workload configurations but not cluster configurations

## Instrumenting Individual Workloads

Individual workloads can be instrumented at the [Kubernetes Pod](https://kubernetes.io/docs/concepts/workloads/pods/)
level. The Archodex Agent runs as a
[Sidecar Container](https://kubernetes.io/docs/concepts/workloads/pods/sidecar-containers/). Because Pods are the
compute unit for both long-running workloads (e.g.
[Deployments](https://kubernetes.io/docs/concepts/workloads/controllers/deployment/)) and one-off tasks (e.g.
[Jobs](https://kubernetes.io/docs/concepts/workloads/controllers/job/)), both workload types can be instrumented by
adding the Archodex Agent as a Pod Sidecar.

<Aside title="Requirements">
  Instrumenting individual workloads using a sidecar container requires a Kubernetes cluster with the
  `SidecarContainers` feature gate enabled. This feature has been enabled by default since Kubernetes v1.29, so most
  clusters should have this feature enabled.
</Aside>

To instrument a workload, add a sidecar container configuration as shown in the following example:

```diff lang="yaml"
 apiVersion: apps/v1
 kind: Deployment
 metadata:
   name: myapp
   labels:
     app: myapp
 spec:
   selector:
     matchLabels:
       app: myapp
   template:
     metadata:
       labels:
         app: myapp
     spec:
       containers:
         - name: myapp
           image: acme/myapp:latest
+      initContainers:
+        - name: archodex-agent
+          image: public.ecr.aws/archodex/agent:latest
+          restartPolicy: Always
+          securityContext:
+            privileged: true
+          env:
+            # Required: Informs agent which Kubernetes node it is running on
+            - name: KUBERNETES_NODE_NAME
+              valueFrom:
+                fieldRef:
+                  fieldPath: spec.nodeName
+            # Optional: If omitted the agent will only log observations
+            - name: ARCHODEX_REPORT_API_KEY
+              value: <report API key>
+      # Required for archodex-agent container to observe workload container processes
+      hostPID: true
```

&lt;TODO: Is `hostPID` required, or with `privileged` can we look up host PIDs or remount the process PID namespace?&gt;

<Aside>
  If your workload already has init containers, adding the Archodex Agent container at the beginning of the list will
  enable it to observe service interactions performed in later init containers.
</Aside>

Once the workload is running, you can view service interaction observations from the pod's archodex-agent container
logs. If you provided an Archodex Report API Key, observations will be logged and sent to the Archodex.com service 20
seconds after agent startup and then once each hour. The agent container will send one final report when the pod is
terminated.

## Instrumenting Clusters

Instrumenting entire Kubernetes clusters is the easiest way to ensure the Archodex Agent captures all interactions
between your workloads and with external services. Archodex provides a [Helm Chart](https://helm.sh/) to simplify
installation. The Chart creates a Kubernetes
[Daemonset](https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/daemon-set-v1/), which is a workload
type that ensures an Archodex Agent container runs on each Kubernetes Node to capture all service interactions.

To install the Archodex Agent helm chart in your cluster,
[install helm on your local machine](https://helm.sh/docs/intro/install/), then run the following commands:

```sh
$ helm repo add archodex https://helm.archodex.com
$ helm install archodex-agent [--set reportApiKey=<reportApiKey>]
```

You can view service interaction observations in the archodex-agent containers running on each Kubernetes Node of the
Cluster. If you provided an Archodex Report API Key, observations from each agent will be logged and sent to the
Archodex.com service 20 seconds after agent startup and then once each hour. Agent containers will send one final report
when a Node or the Daemonset are removed.

### Helm Chart Values

The Archodex Agent helm chart has the following values that can be set:

#### `reportApiKey`

Type: String

Default: `''`

The Archodex Report API Key value. When provided, each agent container will log and send observations to the
Archodex.com service 20 seconds after agent startup and then once each hour. The agent container will send one final
report when a Node or the Daemonset are removed.

#### `logReport`

Type: String

Default: `''`

Set to `'false'` to disable logging observations to agent container logs.

#### `enableRulesets`

Type: Array of Archodex Ruleset IDs

Default: `[]`

Many built-in rulesets are disabled by default. This setting is used to enable rulesets. See built-in ruleset docs for
details on which rulesets are enabled by default.

#### `disableRulesets`

Type: Array of Archodex Ruleset IDs

Default: `[]`

Some built-in rulesets are enabled by default. This setting is used to override and disable these rulesets. See built-in
ruleset docs for details on which rulesets are enabled by default.

#### `additionalRulesets`

Type: Array of URLs

Default: `[]`

Use this setting to extend Archodex Agent instrumentation by providing additional Rulesets.

#### `rulesetInputs`

Type: Map of Ruleset IDs to Input/Value maps

Default: `{}`

Use this setting to provide input values for Rulesets.

---

&lt;TODO: Audit other settings&gt;
