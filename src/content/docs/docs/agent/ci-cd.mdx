---
title: Instrumenting CI/CD Workflows
description: Documentation on using the Archodex Agent in CI/CD Workflows
---

import { Aside } from '@astrojs/starlight/components';

---

Instrumenting service interactions in CI/CD workflow runs provides a wealth of operational intelligence. These runs
often involve service control-plane interactions to create, update, or delete resources through Infrastructure-as-Code
(e.g. [Hashicorp Terraform](https://www.terraform.io/) or [AWS CloudFormation](https://aws.amazon.com/cloudformation/))
or direct API calls (e.g. via cloud-provider CLIs).

## Example CI/CD Observations

After instrumenting a GitHub Actions Workflow with the Archodex Agent we can see operational insights on resources that
were accessed.

### Logged Observations

The following example output might be logged after interactions with a Hashicorp Vault server are observed:

```ansi title="Post Archodex Agent" wrap
 [1mResource captures:[0m
 â”œâ”€ [1mType:[0m [34mGitHub Service[0m
 â”‚  [1mID:[0m [36mhttps://github.com[0m
 â”‚  [1mFirst seen at:[0m 2025-01-28 23:25:36 UTC
 â”‚  [1mLast seen at:[0m 2025-01-28 23:25:36 UTC
 â”‚  â”‚
 â”‚  â”œâ”€ [1mType:[0m [34mActor[0m
 â”‚  â”‚  [1mID:[0m [36mtxase[0m
 â”‚  â”‚  [1mFirst seen at:[0m 2025-01-28 23:25:36 UTC
 â”‚  â”‚  [1mLast seen at:[0m 2025-01-28 23:25:36 UTC
 â”‚  â”‚
 â”‚  â””â”€ [1mType:[0m [34mOrganization[0m
 â”‚     [1mID:[0m [36marchodex[0m
 â”‚     [1mFirst seen at:[0m 2025-01-28 23:25:36 UTC
 â”‚     [1mLast seen at:[0m 2025-01-28 23:25:36 UTC
 â”‚     â”‚
 â”‚     â””â”€ [1mType:[0m [34mGit Repository[0m
 â”‚        [1mID:[0m [36marchodex/archodex-demo-sprockets[0m
 â”‚        [1mFirst seen at:[0m 2025-01-28 23:25:36 UTC
 â”‚        [1mLast seen at:[0m 2025-01-28 23:25:36 UTC
 â”‚        â”‚
 â”‚        â””â”€ [1mType:[0m [34mGitHub Actions Workflow[0m
 â”‚           [1mID:[0m [36marchodex/archodex-demo-sprockets/.github/workflows/deploy.yml@refs/heads/main[0m
 â”‚           [1mFirst seen at:[0m 2025-01-28 23:25:36 UTC
 â”‚           [1mLast seen at:[0m 2025-01-28 23:25:36 UTC
 â”‚
 â””â”€ [1mType:[0m [34mHashiCorp Vault Service[0m
    [1mID:[0m [36mvault.demo.com[0m
    [1mFirst seen at:[0m 2025-01-28 23:25:55 UTC
    [1mLast seen at:[0m 2025-01-28 23:25:55 UTC
    â”‚
    â””â”€ [1mType:[0m [34mSecrets Engine Mount[0m
       [1mID:[0m [36msecret[0m
       [1mFirst seen at:[0m 2025-01-28 23:25:55 UTC
       [1mLast seen at:[0m 2025-01-28 23:25:55 UTC
       â”‚
       â””â”€ [1mType:[0m [34mSecret[0m
          [1mID:[0m [36msecret/db_creds[0m
          [1mFirst seen at:[0m 2025-01-28 23:25:55 UTC
          [1mLast seen at:[0m 2025-01-28 23:25:55 UTC

 [1mEvent captures:[0m
 â”œâ”€ [1mPrincipal chain:[0m [[34mGitHub Service[0m::[36mhttps://github.com[0m]::[[34mActor[0m::[36mtxase[0m]
 â”‚  â””â”€ [1mEvent:[0m [33mAssumed[0m
 â”‚     [1mResource:[0m [[34mGitHub Service[0m::[36mhttps://github.com[0m]::[[34mActor[0m::[36mtxase[0m]
 â”‚     [1mFirst seen at:[0m 2025-01-28 23:25:36 UTC
 â”‚     [1mLast seen at:[0m 2025-01-28 23:25:36 UTC
 â”‚
 â”œâ”€ [1mPrincipal chain:[0m [[34mGitHub Service[0m::[36mhttps://github.com[0m]::[[34mActor[0m::[36mtxase[0m] [33m-(Assumed)->[0m [[34mGitHub Service[0m::[36mhttps://github.com[0m]::[[34mActor[0m::[36mtxase[0m]
 â”‚  â””â”€ [1mEvent:[0m [33mInvoked[0m
 â”‚     [1mResource:[0m [[34mGitHub Service[0m::[36mhttps://github.com[0m]::[[34mOrganization[0m::[36marchodex[0m]::[[34mGit Repository[0m::[36marchodex/archodex-demo-sprockets[0m]::[[34mGitHub Actions Workflow[0m::[36marchodex/archodex-demo-sprockets/.github/workflows/deploy.yml@refs/heads/main[0m]
 â”‚     [1mFirst seen at:[0m 2025-01-28 23:25:36 UTC
 â”‚     [1mLast seen at:[0m 2025-01-28 23:25:36 UTC
 â”‚
 â””â”€ [1mPrincipal chain:[0m [[34mGitHub Service[0m::[36mhttps://github.com[0m]::[[34mActor[0m::[36mtxase[0m] [33m-(Assumed)->[0m [[34mGitHub Service[0m::[36mhttps://github.com[0m]::[[34mActor[0m::[36mtxase[0m] [33m-(Invoked)->[0m [[34mGitHub Service[0m::[36mhttps://github.com[0m]::[[34mOrganization[0m::[36marchodex[0m]::[[34mGit Repository[0m::[36marchodex/archodex-demo-sprockets[0m]::[[34mGitHub Actions Workflow[0m::[36marchodex/archodex-demo-sprockets/.github/workflows/deploy.yml@refs/heads/main[0m]
    â””â”€ [1mEvent:[0m [33mRead[0m
       [1mResource:[0m [[34mHashiCorp Vault Service[0m::[36mvault.example.com[0m]::[[34mSecrets Engine Mount[0m::[36msecret[0m]::[[34mSecret[0m::[36msecret/db_creds[0m]
       [1mFirst seen at:[0m 2025-01-28 23:25:55 UTC
       [1mLast seen at:[0m 2025-01-28 23:25:55 UTC
```

### View Observations in Archodex Dashboard

If the Agent is configured with a Report API Key this data would be sent to the Archodex backend service. We could find
these secrets and the workflow accesses in the [Archodex Dashboard](../dashboard):

&lt;TODO: Screenshot&gt;

## Instrumenting GitHub Actions

The Archodex Agent is easily installed into [GitHub Actions](https://github.com/features/actions) CI/CD workflows using
the [archodex-agent-action](https://github.com/marketplace/actions/archodex-agent-action) GitHub Action:

```diff lang="yaml" wrap
 name: Example Workflow

 on:
   workflow_dispatch:

 jobs:
   build:
     steps:
+      - name: Archodex Agent
+        uses: archodex/archodex-agent-action@v1
+
       - name: Checkout Repository
         uses: actions/checkout@v4

       - name: Import Secrets from Vault
         id: import-secrets
         uses: hashicorp/vault-action@v3
         with:
           # ... (Vault access parameters omitted)
           secrets: secret/data/db_creds password
```

### Inputs

```yaml
- name: Archodex Agent
  uses: archodex/archodex-agent-action@v1
  with:
    # Archodex Report API Key
    # Type: String
    # Default: <unset>
    #
    # Providing a Report API Key enables the Agent to send observed service
    # interactions to an Archodex backend service. The agent will only log
    # observed service interactions if left unset.
    #
    # Example:
    report_api_key: ${{ secrets.ArchodexReportApiKey }}

    # Log Observed Service Interactions
    # Type: Boolean
    # Default: true
    #
    # Use this setting to disable logging of observed service interactions at
    # workflow completion.
    #
    # Example:
    log_report: false

    # Enable Built-in Archodex Rulesets
    # Type: Array of Archodex Ruleset IDs
    # Default: []
    #
    # Many built-in rulesets are disabled by default. This setting is used to
    # enable rulesets. See built-in ruleset docs for details on which rulesets
    # are enabled by default.
    #
    # Example:
    enable_rulesets:
      - hashicorp_vault@v1

    # Disable Built-in Archodex Rulesets
    # Type: Array of Archodex Ruleset IDs
    # Default: []
    #
    # Some built-in rulesets are enabled by default. This setting is used to
    # override and disable these rulesets. See built-in ruleset docs for details
    # on which rulesets are enabled by default.
    #
    # Example:
    disable_rulesets:
      - github_actions@v1

    # Use additional rulesets from paths or URLs
    # Type: Array of file paths or URLs
    # Default: []
    #
    # Use this setting to extend Archodex Agent instrumentation by providing
    # additional Rulesets.
    #
    # Example:
    additional_rulesets:
      - archodex/internal_db_service.yaml
      - https://gist.githubusercontent.com/acme/b62773ab7cc817d9d55e2c76c5477715/raw/acme_dns_service.yaml

    # Provide values for Ruleset Inputs
    # Type: Map of Ruleset IDs to Input/Value maps
    # Default: {}
    #
    # Use this setting to provide input values for Rulesets. Note that many
    # values may already be captured through environment variables. Values
    # specified here take precedence over values from environment variables.
    ruleset_input:
      hashicorp_vault@v1:
        VaultAddr: vault.acme.com
```

## Instrumenting Other CI/CD Workflows

The Archodex Agent is easy to use in any CI/CD workflow. It can be started as a background process or run as a
background Docker container.

<Aside>
  Ensure the agent background process receives a shutdown signal (i.e. SIGTERM) or the agent Docker container is
  shutdown at the end of each workflow execution. This may or may not occur automatically on different CI/CD systems.
</Aside>
